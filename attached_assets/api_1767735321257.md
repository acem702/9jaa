# Political Sentiment Platform - Laravel Backend

A REST API backend for a public political sentiment platform using YES/NO confidence markets with Automated Market Maker (AMM) pricing based on the constant product formula.

## Features

- **Confidence Markets**: Users express confidence on political questions using YES/NO positions
- **AMM Pricing**: Constant product formula (k = yes_pool × no_pool) for automatic price discovery
- **Influence Credits**: Non-monetary virtual currency for trading
- **Admin Controls**: Create, lock, and resolve questions
- **Real-time Analytics**: Chart data, price history, volume tracking
- **Public APIs**: Read-only endpoints for frontend consumption

## Installation

### Requirements
- PHP 8.1+
- Composer
- MySQL 8.0+ or PostgreSQL
- Laravel 10.x

### Setup

```bash
# Clone and install dependencies
composer install

# Configure environment
cp .env.example .env
php artisan key:generate

# Update database credentials in .env
DB_CONNECTION=mysql
DB_HOST=127.0.0.1
DB_PORT=3306
DB_DATABASE=sentiment_platform
DB_USERNAME=root
DB_PASSWORD=

# Run migrations
php artisan migrate

# Seed database with sample data
php artisan db:seed

# Install Laravel Sanctum for API authentication
php artisan vendor:publish --provider="Laravel\Sanctum\SanctumServiceProvider"

# Start development server
php artisan serve
```

### Admin Credentials (from seeder)
- Email: `admin@example.com`
- Password: `password`

### Test Users
- `user1@example.com` through `user10@example.com`
- Password: `password`
- Starting credits: 1,000

## API Endpoints

### Authentication

#### Register
```http
POST /api/v1/register
Content-Type: application/json

{
  "name": "John Doe",
  "email": "john@example.com",
  "password": "password123",
  "password_confirmation": "password123"
}
```

#### Login
```http
POST /api/v1/login
Content-Type: application/json

{
  "email": "john@example.com",
  "password": "password123"
}

Response:
{
  "message": "Login successful",
  "user": { ... },
  "token": "1|abc123..."
}
```

#### Logout
```http
POST /api/v1/logout
Authorization: Bearer {token}
```

### Public Endpoints (No Auth Required)

#### List Questions
```http
GET /api/v1/questions?status=active&page=1

Response:
{
  "questions": [
    {
      "id": 1,
      "title": "Will GDP growth exceed 3% in 2026?",
      "description": "...",
      "status": "active",
      "market": {
        "yes_price": 0.547,
        "no_price": 0.453,
        "yes_pool": 1100.50,
        "no_pool": 909.09
      },
      "created_at": "2026-01-01T00:00:00Z"
    }
  ],
  "meta": { ... }
}
```

#### Get Question Details
```http
GET /api/v1/questions/{id}
```

#### Dashboard Overview
```http
GET /api/v1/charts/dashboard

Response:
{
  "overview": {
    "active_markets": 5,
    "total_volume": 15420.50,
    "total_trades": 142,
    "active_traders": 28
  },
  "trending": [ ... ]
}
```

#### Price History
```http
GET /api/v1/charts/questions/{id}/price-history?limit=100

Response:
{
  "question_id": 1,
  "data": [
    {
      "timestamp": 1704067200,
      "date": "2026-01-01T00:00:00Z",
      "yes_price": 0.500,
      "no_price": 0.500,
      "yes_pool": 1000.00,
      "no_pool": 1000.00
    }
  ],
  "current": {
    "yes_price": 0.547,
    "no_price": 0.453
  }
}
```

#### Volume History
```http
GET /api/v1/charts/questions/{id}/volume

Response:
{
  "question_id": 1,
  "data": [
    {
      "timestamp": 1704067200,
      "date": "2026-01-01 12:00:00",
      "volume": 150.25,
      "trade_count": 8
    }
  ]
}
```

#### Sentiment Distribution
```http
GET /api/v1/charts/questions/{id}/sentiment

Response:
{
  "sentiment": {
    "yes_price": 0.547,
    "no_price": 0.453,
    "yes_shares": 125.50,
    "no_shares": 98.25,
    "yes_holders": 15,
    "no_holders": 12,
    "total_holders": 27
  }
}
```

#### Recent Trades
```http
GET /api/v1/charts/questions/{id}/trades?limit=20
```

#### Market Statistics
```http
GET /api/v1/charts/questions/{id}/stats

Response:
{
  "stats": {
    "current_yes_price": 0.547,
    "price_change_24h": 4.7,
    "high_24h": 0.555,
    "low_24h": 0.520,
    "total_volume": 1542.75,
    "total_trades": 45,
    "unique_traders": 18,
    "liquidity": {
      "yes_pool": 1100.50,
      "no_pool": 909.09,
      "total": 2009.59
    }
  }
}
```

#### Leaderboard
```http
GET /api/v1/charts/leaderboard?type=profit&limit=10

Types: profit, volume, accuracy
```

### Protected Endpoints (Auth Required)

Include token in header: `Authorization: Bearer {token}`

#### Get Current User
```http
GET /api/v1/user
```

#### Get Trade Quote
```http
POST /api/v1/trade/questions/{id}/quote
Content-Type: application/json

{
  "position": true,  // true=YES, false=NO
  "shares": 10.5
}

Response:
{
  "position": "YES",
  "shares": 10.5,
  "cost": 5.75,
  "price_per_share": 0.548,
  "current_price": 0.547
}
```

#### Buy Shares
```http
POST /api/v1/trade/questions/{id}/buy
Content-Type: application/json

{
  "position": true,
  "shares": 10.5
}

Response:
{
  "message": "Trade executed successfully",
  "position": { ... },
  "transaction": {
    "cost": 5.75,
    "shares": 10.5,
    "price_per_share": 0.548
  },
  "user": {
    "remaining_credits": 994.25
  }
}
```

#### Sell Shares
```http
POST /api/v1/trade/questions/{id}/sell
Content-Type: application/json

{
  "position": true,
  "shares": 5.0
}
```

#### Get User Positions
```http
GET /api/v1/trade/positions

Response:
{
  "positions": [
    {
      "id": 1,
      "question": { ... },
      "position": "YES",
      "shares": 10.5,
      "cost": 5.75,
      "current_value": 6.20,
      "profit_loss": 0.45,
      "profit_loss_pct": 7.83
    }
  ]
}
```

### Admin Endpoints

Requires `is_admin=true` and Bearer token

#### Create Question
```http
POST /api/v1/questions
Content-Type: application/json
Authorization: Bearer {admin_token}

{
  "title": "Will there be a recession in 2026?",
  "description": "Resolution: YES if NBER declares recession for any quarter in 2026."
}
```

#### Lock Question
```http
POST /api/v1/questions/{id}/lock
Authorization: Bearer {admin_token}

Response:
{
  "message": "Question locked successfully",
  "question": { ... }
}
```

#### Resolve Question
```http
POST /api/v1/questions/{id}/resolve
Content-Type: application/json
Authorization: Bearer {admin_token}

{
  "resolution": true  // true=YES won, false=NO won
}

Response:
{
  "message": "Question resolved successfully",
  "question": { ... }
}
```

## AMM Pricing Formula

The system uses a constant product market maker (CPMM):

```
k = yes_pool × no_pool (constant)

YES price = no_pool / (yes_pool + no_pool)
NO price = yes_pool / (yes_pool + no_pool)

Buy cost = pool_before - pool_after (where k remains constant)
```

### Example Trade

Initial state:
- yes_pool = 1000
- no_pool = 1000
- k = 1,000,000
- YES price = 0.50

User buys 10 YES shares:
- New yes_pool = 1010
- New no_pool = k / 1010 = 990.099
- Cost = 1000 - 990.099 = 9.901 credits
- New YES price = 990.099 / 2000.099 = 0.495

## Database Schema

### Users
- id, name, email, password, is_admin, influence_credits

### Questions
- id, title, description, status (active/locked/resolved), resolution, created_by

### Markets
- id, question_id, yes_pool, no_pool, k_constant

### Positions
- id, user_id, question_id, position, shares, cost, current_value

### Transactions
- id, user_id, question_id, type, position, shares, credits_amount, price_per_share, pool snapshots

### Price History
- id, question_id, yes_price, no_price, yes_pool, no_pool, recorded_at

## Testing

Run PHPUnit tests:
```bash
php artisan test
```

## CORS Configuration

Add to `config/cors.php` for frontend:
```php
'paths' => ['api/*'],
'allowed_methods' => ['*'],
'allowed_origins' => ['http://localhost:3000'],
'allowed_headers' => ['*'],
'exposed_headers' => [],
'max_age' => 0,
'supports_credentials' => true,
```

## Production Considerations

1. **Rate Limiting**: Add throttle middleware to prevent abuse
2. **Caching**: Cache price history and leaderboard queries
3. **Queue Jobs**: Process resolutions asynchronously
4. **Validation**: Add more comprehensive input validation
5. **Logging**: Implement audit trail for admin actions
6. **Backups**: Regular database backups for transaction history
7. **Monitoring**: Track AMM pool health and liquidity

## License

MIT